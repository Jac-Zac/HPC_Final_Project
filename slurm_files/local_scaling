#!/bin/bash

EXEC="mpirun -np 1 stencil_parallel"
ARGS="-x 20000 -y 20000 -n 100 -o 0"

# Output summary file
RESULTS_FILE=openmp_scaling_serial.txt
echo "Threads,TotalTime,EnergyCompTime,InjectedEnergy,SystemEnergy" > $RESULTS_FILE

# Loop over thread counts
for THREADS in 1 2 4 8
do
    echo ">>> Running with $THREADS OpenMP threads"

    # Set OpenMP environment variables
    export OMP_NUM_THREADS=$THREADS
    export OMP_PLACES=cores
    export OMP_PROC_BIND=spread

    OUTPUT=$(mktemp)

    # Compile
    make MODE=parallel

    # Run the executable
    $EXEC $ARGS > $OUTPUT

    # Extract values from output log
    TOTAL_TIME=$(grep "Total time" $OUTPUT | awk '{print $3}')
    ENERGY_TIME=$(grep "Total energy computaton time" $OUTPUT | awk '{print $5}')
    INJECTED=$(grep "injected energy" $OUTPUT | awk '{print $4}' | tr -d ',')
    SYSTEM=$(grep "system energy" $OUTPUT | awk '{print $7}')

    # Append to results file
    echo "$THREADS,$TOTAL_TIME,$ENERGY_TIME,$INJECTED,$SYSTEM" >> $RESULTS_FILE

    rm $OUTPUT
done
