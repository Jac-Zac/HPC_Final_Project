#!/bin/bash
#SBATCH --nodes=1                   # 1 node
#SBATCH --ntasks=1                  # total MPI tasks across nodes
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=64          # OpenMP threads per MPI task
#SBATCH --mem=0                     # use all available memory
#SBATCH --partition=GENOA
#SBATCH -t 00:05:00                 # 5 minutes for profiling and test runs
#SBATCH --exclusive                 # exclusive node use
#SBATCH --job-name=pgo_test

# Set OpenMP variables
export OMP_NUM_THREADS=8
export OMP_PLACES=cores
export OMP_PROC_BIND=close
export OMP_DISPLAY_AFFINITY=TRUE

# Load MPI module if needed
module load openMPI/5.0.5

# Executable base name
EXEC=./stencil_parallel

# Arguments to executable
ARGS="-x 10000 -y 10000 -n 50 -o 0"

echo "Running default, non-optimized version"
make clean
make MODE=parallel CFLAGS="-O3 -march=native -fopenmp -Iinclude"
$EXEC $ARGS > default_run.log

echo "Building instrumented version for PGO"
make clean
make MODE=parallel CFLAGS="-O3 -march=native -fopenmp -Iinclude -fprofile-generate"

echo "Running instrumented version to collect profile data"
$EXEC $ARGS

echo "Building optimized version using profile data"
make clean
make MODE=parallel TILE=1 CFLAGS="-O3 -march=native -fopenmp -Iinclude -fprofile-use -fprofile-correction"

echo "Running optimized version (PGO)"
$EXEC $ARGS > pgo_run.log

echo "Compare runtime outputs and performance between default_run.log and pgo_run.log"
